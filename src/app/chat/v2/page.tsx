'use client';

import React, { useEffect, useState } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import DebateChatContainer from '@/components/chat/v2/DebateChatContainer';
import chatService, { ChatRoom, ChatMessage } from '@/lib/ai/chatService';

export default function ChatPageV2() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const chatIdParam = searchParams ? searchParams.get('id') : null;
  
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [chatData, setChatData] = useState<ChatRoom | null>(null);
  const [isGeneratingResponse, setIsGeneratingResponse] = useState(false);
  const [socketClient, setSocketClient] = useState<any>(null);
  const [username, setUsername] = useState<string>('');

  // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú
  useEffect(() => {
    const loadUserInfo = async () => {
      try {
        const response = await fetch('/api/user/profile');
        if (response.ok) {
          const userData = await response.json();
          const userDisplayName = userData.username || userData.name || `User_${Math.floor(Math.random() * 10000)}`;
          setUsername(userDisplayName);
          sessionStorage.setItem('chat_username', userDisplayName);
          console.log('‚úÖ V2: ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìúÎê®:', userDisplayName);
        } else {
          const storedUsername = sessionStorage.getItem('chat_username') || `User_${Math.floor(Math.random() * 10000)}`;
          setUsername(storedUsername);
          sessionStorage.setItem('chat_username', storedUsername);
        }
      } catch (error) {
        console.error('V2: ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
        const fallbackUsername = `User_${Math.floor(Math.random() * 10000)}`;
        setUsername(fallbackUsername);
        sessionStorage.setItem('chat_username', fallbackUsername);
      }
    };
    
    loadUserInfo();
  }, []);

  useEffect(() => {
    setLoading(true);
    setError(null);
    setChatData(null);
    
    if (!chatIdParam) {
      setError('No chat ID provided');
      setLoading(false);
      return;
    }

    const chatId = Number(chatIdParam);
    
    if (isNaN(chatId) || chatId <= 0) {
      console.error(`Invalid chat ID format: ${chatIdParam}`);
      setError('Invalid chat room ID format');
      setLoading(false);
      return;
    }

    const loadChatData = async () => {
      try {
        setLoading(true);
        setError(null);
        
        console.log(`üîç CHAT PAGE V2: Fetching chat room with ID: ${chatId}`);
        const room = await chatService.getChatRoomById(chatId);
        
        if (!room) {
          console.error('Room not found for ID:', chatId);
          setError('Chat room not found');
          return;
        }
        
        console.log(`üîç CHAT PAGE V2: Successfully loaded room #${room.id} (${room.title})`);
        
        // Ensure dialogueType is set
        if (!room.dialogueType) {
          room.dialogueType = 'free';
        }
        
        setChatData(JSON.parse(JSON.stringify(room)));
      } catch (error) {
        console.error('Failed to load chat:', error);
        setError('Failed to load chat data. Please try again.');
      } finally {
        setLoading(false);
      }
    };
    
    loadChatData();
  }, [chatIdParam, router]);

  // Socket.IO Ïó∞Í≤∞ Î∞è Ïã§ÏãúÍ∞Ñ Î©îÏãúÏßÄ ÏàòÏã† ÏÑ§Ï†ï
  useEffect(() => {
    let socketInstance: any = null;

    const initializeSocket = async () => {
      if (!chatData?.id || !username) return;

      try {
        // socketClient Ïù∏Ïä§ÌÑ¥Ïä§ ÏûÑÌè¨Ìä∏ 
        const socketClient = (await import('@/lib/socket/socketClient')).default;
        socketInstance = socketClient;
        await socketInstance.init(username);
        
        // Î∞©Ïóê Ï∞∏Í∞Ä (username Ï†ÑÎã¨)
        const roomIdNum = typeof chatData.id === 'string' ? parseInt(chatData.id) : chatData.id;
        socketInstance.joinRoom(roomIdNum, username);
        
        // new-message Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        socketInstance.on('new-message', (data: { roomId: string, message: ChatMessage }) => {
          console.log('üéØ [V2] ÏÜåÏºì Ïù¥Î≤§Ìä∏ ÏàòÏã†: new-message');
          console.log('üéØ [V2] ÏàòÏã† Îç∞Ïù¥ÌÑ∞:', JSON.stringify(data).substring(0, 300));
          console.log('üéØ [V2] ÌòÑÏû¨ Î∞© ID:', String(chatData.id));
          console.log('üéØ [V2] ÏàòÏã†Îêú Î∞© ID:', String(data.roomId));
          
          // ÌòÑÏû¨ Î∞©Ïùò Î©îÏãúÏßÄÏù∏ÏßÄ ÌôïÏù∏
          const currentRoomId = String(chatData.id);
          const receivedRoomId = String(data.roomId);
          
          if (currentRoomId === receivedRoomId && data.message) {
            console.log('‚úÖ [V2] Î∞© ID ÏùºÏπò! Î©îÏãúÏßÄ UIÏóê Ï∂îÍ∞Ä');
            console.log('‚úÖ [V2] Î©îÏãúÏßÄ ÎÇ¥Ïö©:', data.message.text?.substring(0, 100));
            
            setChatData(prev => {
              if (!prev) return prev;
              
              console.log('üîÑ [V2] setChatData Ìò∏Ï∂ú - ÏÉà Î©îÏãúÏßÄ Ï∂îÍ∞Ä');
              console.log('üîÑ [V2] Í∏∞Ï°¥ Î©îÏãúÏßÄ Ïàò:', prev.messages?.length || 0);
              console.log('üîÑ [V2] Ï∂îÍ∞ÄÌï† Î©îÏãúÏßÄ ID:', data.message.id);
              
              const newChatData = {
                ...prev,
                messages: [...(prev.messages || []), data.message]
              };
              
              console.log('üîÑ [V2] ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Î©îÏãúÏßÄ Ïàò:', newChatData.messages?.length || 0);
              return newChatData;
            });
          } else {
            console.log('‚ùå [V2] Î∞© ID Î∂àÏùºÏπò ÎòêÎäî Î©îÏãúÏßÄ ÏóÜÏùå');
            console.log('‚ùå [V2] ÌòÑÏû¨ Î∞©:', currentRoomId, 'ÏàòÏã† Î∞©:', receivedRoomId, 'Î©îÏãúÏßÄ Ï°¥Ïû¨:', !!data.message);
          }
        });
        
        // Ï∂îÍ∞Ä ÎîîÎ≤ÑÍ∑∏ Ïù¥Î≤§Ìä∏Îì§
        socketInstance.on('connect', () => {
          console.log('üîó [V2] Socket Ïó∞Í≤∞Îê®:', socketInstance.getSocket()?.id);
        });
        
        socketInstance.on('disconnect', () => {
          console.log('‚ùå [V2] Socket Ïó∞Í≤∞ Ìï¥Ï†úÎê®');
        });
        
        // Î™®Îì† Ïù¥Î≤§Ìä∏ Ï∫êÏπò
        socketInstance.getSocket()?.onAny((eventName: string, ...args: any[]) => {
          console.log(`üéß [V2] Î∞õÏùÄ Ïù¥Î≤§Ìä∏: ${eventName}`, args);
        });
        
        setSocketClient(socketInstance);
        console.log('V2: Socket.IO Ïó∞Í≤∞ ÏôÑÎ£å');
        
      } catch (error) {
        console.error('V2: Socket.IO Ïó∞Í≤∞ Ïã§Ìå®:', error);
      }
    };

    if (chatData?.id) {
      initializeSocket();
    }

    return () => {
      if (socketInstance) {
        if (chatData?.id && username) {
          const roomIdNum = typeof chatData.id === 'string' ? parseInt(chatData.id) : chatData.id;
          socketInstance.leaveRoom(roomIdNum, username);
        }
        socketInstance.disconnect();
      }
    };
  }, [chatData?.id, username]);

  const handleBackToOpenChat = () => {
    router.push('/open-chat');
  };

  const handleSendMessage = async (message: string) => {
    if (!chatData) return;
    
    try {
      console.log(`üí¨ V2: User message sent: ${message}`);
      
      // Í∞ÑÎã®Ìïú Î©îÏãúÏßÄ Ï†ÑÏÜ° (Í∏∞Ï°¥ Î°úÏßÅ Îã®ÏàúÌôî)
      const result = await chatService.sendMessage(chatData.id, message, {
        id: `user-${Date.now()}`,
        text: message.trim(),
        sender: username || 'User',
        isUser: true,
        timestamp: new Date().toISOString(),
        role: 'user'
      });
      
      console.log(`‚úÖ V2: Message sent successfully:`, result);
      
      // Ï±ÑÌåÖ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ®
      const updatedRoom = await chatService.getChatRoomById(chatData.id);
      if (updatedRoom) {
        setChatData(updatedRoom);
      }
    } catch (error) {
      console.error('‚ùå V2: Message sending failed:', error);
    }
  };

  const handleRefreshChat = async () => {
    if (!chatData) return;
    
    console.log('üîÑ [V2] handleRefreshChat Ìò∏Ï∂úÎê®');
    console.log('üîÑ [V2] ÏÉàÎ°úÍ≥†Ïπ® Ï†Ñ Î©îÏãúÏßÄ Ïàò:', chatData.messages?.length || 0);
    
    setLoading(true);
    try {
      const refreshedRoom = await chatService.getChatRoomById(chatData.id);
      if (refreshedRoom) {
        console.log('üîÑ [V2] ÏÑúÎ≤ÑÏóêÏÑú Í∞ÄÏ†∏Ïò® Î©îÏãúÏßÄ Ïàò:', refreshedRoom.messages?.length || 0);
        setChatData(JSON.parse(JSON.stringify(refreshedRoom)));
        console.log('üîÑ [V2] ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å - Îç∞Ïù¥ÌÑ∞ ÍµêÏ≤¥Îê®');
      }
    } catch (error) {
      console.error('Failed to refresh chat:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleRequestNextMessage = async () => {
    if (!chatData) return;
    
    try {
      setIsGeneratingResponse(true);
      console.log('üîÑ V2: Requesting next debate message for room:', chatData.id);
      
      // Í∞ÑÎã®Ìïú Îã§Ïùå Î©îÏãúÏßÄ ÏöîÏ≤≠ (Í∏∞Ï°¥ Î°úÏßÅ Îã®ÏàúÌôî)
      const apiBaseUrl = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000';
      const roomIdNum = typeof chatData.id === 'string' ? parseInt(chatData.id) : chatData.id;
      
      const response = await fetch(`${apiBaseUrl}/api/chat/debate/${roomIdNum}/next-message`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || 'Next Î©îÏãúÏßÄ ÏöîÏ≤≠ Ïã§Ìå®');
      }
      
      const data = await response.json();
      console.log('‚úÖ V2: Next Î©îÏãúÏßÄ ÏöîÏ≤≠ ÏÑ±Í≥µ:', data);
      
      // Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® - ÏûÑÏãúÎ°ú ÎπÑÌôúÏÑ±ÌôîÌïòÏó¨ ÌÖåÏä§Ìä∏
      console.log('‚è∏Ô∏è [V2] ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ® ÎπÑÌôúÏÑ±ÌôîÎê® - Socket Î©îÏãúÏßÄÎßå ÏÇ¨Ïö©');
      /*
      setTimeout(() => {
        handleRefreshChat();
      }, 1000);
      */
      
    } catch (error) {
      console.error('‚ùå V2: Next Î©îÏãúÏßÄ ÏöîÏ≤≠ Ï§ë Ïò§Î•ò:', error);
    } finally {
      setIsGeneratingResponse(false);
    }
  };

  if (loading) {
    return (
      <div className="fixed inset-0 z-50 w-screen h-screen bg-white flex justify-center items-center">
        <div className="animate-pulse flex flex-col items-center">
          <div className="h-8 w-48 bg-gray-200 rounded mb-4"></div>
          <div className="h-4 w-32 bg-gray-200 rounded"></div>
          <div className="text-sm text-blue-600 mt-4">V2 Loading...</div>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="fixed inset-0 z-50 w-screen h-screen bg-white flex justify-center items-center flex-col">
        <p className="text-xl text-gray-500 mb-4">{error}</p>
        <div className="text-sm text-red-600 mb-4">V2 Error Page</div>
        <button 
          onClick={handleBackToOpenChat}
          className="px-4 py-2 bg-black text-white rounded-md"
        >
          Back to Open Chat
        </button>
      </div>
    );
  }

  if (!chatData) {
    return (
      <div className="fixed inset-0 z-50 w-screen h-screen bg-white flex justify-center items-center">
        <p className="text-xl text-gray-500">Chat not found (V2)</p>
      </div>
    );
  }

  // V2 Íµ¨Ï°∞ÏóêÏÑúÎäî debate ÌÉÄÏûÖÎßå ÏßÄÏõê (Ï†êÏßÑÏ†Å ÌôïÏû• ÏòàÏ†ï)
  if (chatData.dialogueType !== 'debate') {
    return (
      <div className="fixed inset-0 z-50 w-screen h-screen bg-white flex justify-center items-center flex-col">
        <p className="text-xl text-gray-500 mb-4">
          V2 Íµ¨Ï°∞Îäî ÌòÑÏû¨ ÌÜ†Î°†(debate) Ï±ÑÌåÖÎßå ÏßÄÏõêÌï©ÎãàÎã§.
        </p>
        <div className="text-sm text-blue-600 mb-4">
          ÌòÑÏû¨ Ï±ÑÌåÖ ÌÉÄÏûÖ: {chatData.dialogueType}
        </div>
        <button 
          onClick={() => router.push(`/chat?id=${chatData.id}`)}
          className="px-4 py-2 bg-blue-600 text-white rounded-md mr-2"
        >
          Í∏∞Ï°¥ Î≤ÑÏ†ÑÏúºÎ°ú Î≥¥Í∏∞
        </button>
        <button 
          onClick={handleBackToOpenChat}
          className="px-4 py-2 bg-gray-600 text-white rounded-md"
        >
          Back to Open Chat
        </button>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 z-50 w-screen h-screen bg-white">
      {/* Î©îÏù∏ Ï±ÑÌåÖ Ïª®ÌÖåÏù¥ÎÑà */}
      <div className="h-full">
        <DebateChatContainer
          room={{
            ...chatData,
            id: typeof chatData.id === 'string' ? parseInt(chatData.id) : chatData.id,
            dialogueType: chatData.dialogueType || 'debate'
          }}
          messages={chatData.messages || []}
          npcDetails={chatData.npcDetails || []}
          onSendMessage={handleSendMessage}
          onRefresh={handleRefreshChat}
          isLoading={loading}
          isGeneratingResponse={isGeneratingResponse}
          username={username || 'You'}
          onEndChat={() => router.push('/open-chat')}
          userRole={
            chatData.pro?.includes(username) || chatData.pro?.includes('You') ? 'pro' :
            chatData.con?.includes(username) || chatData.con?.includes('You') ? 'con' :
            'neutral'
          }
          onRequestNextMessage={handleRequestNextMessage}
        />
      </div>
      
      {/* Í∏ÄÎ°úÎ≤å Ïä§ÌÉÄÏùº */}
      <style jsx global>{`
        body.chat-page-open header {
          display: none !important;
        }
        body.chat-page-open {
          overflow: hidden;
        }
      `}</style>
    </div>
  );
} 